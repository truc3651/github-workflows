name: "Update Helm values.yaml"
description: "Updates the Helm chart values.yaml file with the new image and deployment timestamp."

inputs:
  deployments_repo_token:
    description: ""
    required: true
  environment:
    description: ""
    required: true
  service_name:
    description: ""
    required: true
  image:
    description: ""
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
      with:
        repository: 'truc3651/backend-deployments'
        token: ${{ inputs.deployments_repo_token }}
        path: backend-deployments

    - name: Install yq
      shell: bash
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Update values.yaml
      shell: bash
      run: |
        cd backend-deployments/apps/${{ inputs.environment }}/${{ inputs.service_name }}

        yq eval ".image = \"${{ inputs.image }}\"" -i values.yaml
        yq eval ".deploymentTimestamp = \"$(date +%s)\"" -i values.yaml

    - name: Commit & push
      shell: bash
      run: |
        cd backend-deployments
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .
        git commit -m "Update ${{ inputs.service_name }} image"
        git push origin master
